---
- hosts: 127.0.0.1
  connection: local
  pre_tasks:
    - name: Check for preference file
      stat: path=preferences.fact
      register: preferences
      ignore_errors: yes
    - name: Create directory for ansible custom facts
      file: state=directory recurse=yes path=/etc/ansible/facts.d
      sudo: yes
      when: preferences.stat.exists
    - name: Install preferences custom fact
      copy: src=preferences.fact dest=/etc/ansible/facts.d
      sudo: yes
      when: preferences.stat.exists
    - name: Re-read facts after adding custom fact
      setup: filter=ansible_local
      when: preferences.stat.exists

  roles:
    - common
    - { role: yum_packages, when: "ansible_pkg_mgr == 'yum'" }
    - { role: apt_packages, when: "ansible_pkg_mgr == 'apt'" }
